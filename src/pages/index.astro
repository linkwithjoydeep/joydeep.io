---
import content from "../data/content.json"

import BaseLayout from "../layouts/BaseLayout.astro"
import ThemeSwitcher from "../layouts/ThemeSwitcher.astro"

const socialIcons = content.socialIcons as Record<string, { title: string; svg: string }>;

interface RepoData {
  name: string;
  description: string;
  stars: number;
  forks: number;
  language: string;
  topics: string[];
  updatedAt: string;
}

async function fetchGitHubRepoData(owner: string, repo: string): Promise<RepoData | null> {
  try {
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status}`);
    }
    const data = await response.json();
    return {
      name: data.name,
      description: data.description,
      stars: data.stargazers_count,
      forks: data.forks_count,
      language: data.language,
      topics: data.topics || [],
      updatedAt: data.updated_at
    };
  } catch (error) {
    console.error(`Error fetching data for ${owner}/${repo}:`, error);
    return null;
  }
}

// Fetch all repo data at build time
const reposData = await Promise.all(
  content.githubRepos.map(({ owner, repo }) => fetchGitHubRepoData(owner, repo))
);
---

<BaseLayout>
  <ThemeSwitcher />
  <div class="container">
    <header>
      <div class="header-content">
        <div class="header-text">
          <h1 class="name">{content.name}</h1>
          <p class="title">{content.title}</p>
          <div class="contact-info">
            <span class="email-wrapper">
              Email: <a href={`mailto:${content.email}`}>{content.email}</a>
              <button class="copy-btn" data-email={content.email} title="Copy email">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                  <path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
              </button>
              <span class="copy-tooltip" id="copyTooltip">Copied!</span>
            </span>
            <span>Location: {content.location}</span>
          </div>
          <div class="social-links">
            {Object.entries(content.social).map(([platform, url]) => (
              <a 
                href={url} 
                target={platform !== 'email' ? '_blank' : undefined}
                class="social-link" 
                title={socialIcons[platform].title}
                aria-label={socialIcons[platform].title}
              >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d={socialIcons[platform].svg} />
                </svg>
              </a>
            ))}
          </div>
        </div>
        <div class="profile-picture">
          <img src={content.profileImage} alt={content.name}>
        </div>
      </div>
    </header>

    <div class="about-me">
      <h2 class="section-title">About Me</h2>
      <p>{content.about}</p>
    </div>

    <section id="skills">
      <h2 class="section-title">Skills</h2>
      <div class="skills-grid">
      {content.skills.map((skill) => (
        <span class="skill-tag">{skill}</span>
      ))}
      </div>
    </section>

    <section id="experience">
      <h2 class="section-title">Experience</h2>
      {content.experiences.map((experience) => (
      <div class="experience-item">
        <div class="experience-header">
          <h3 class="job-title">{experience.title}</h3>
          <div class="company-period">
            <span class="company">{experience.company}</span>
            <span class="period">{experience.period}</span>
          </div>
        </div>
        <p class="experience-description">
          {experience.description}
        </p>
        <ul class="achievements">
          {experience.achievements.map((achievement) => (
          <li>{achievement}</li>
          ))}
        </ul>
      </div>
      ))}
    </section>

    <section id="recent-work">
      <h2 class="section-title">Recent Work</h2>
      
      {content.githubRepos.map((repoConfig, index) => {
        const repoData = reposData[index];
        const githubUrl = `https://github.com/${repoConfig.owner}/${repoConfig.repo}`;
        
        return (
          <div class="project-card">
            <div class="project-card-header">
              <h3 class="project-title">{repoData?.name || repoConfig.repo}</h3>
              {repoData && (
                <span class="github-stars">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                  {repoData.stars}
                </span>
              )}
            </div>
            
            <p class="project-description">
              {repoData?.description || "No description available"}
            </p>
            
            <div class="tech-stack">
              {repoData?.language && (
                <span class="tech-tag">{repoData.language}</span>
              )}
              {repoConfig.tags?.map(tag => (
                <span class="tech-tag">{tag}</span>
              ))}
            </div>
            
            <div class="project-actions">
              {repoConfig.liveDemo && (
                <a href={repoConfig.liveDemo} target="_blank" class="project-btn demo-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm2-8h8v2H8v-2zm0 4h8v2H8v-2z"/>
                  </svg>
                  Live Demo
                </a>
              )}
              
              <a href={githubUrl} target="_blank" class="project-btn github-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                  <path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
                View on GitHub
              </a>
            </div>
          </div>
        );
      })}
      
      <div class="view-more-projects">
        <a href="https://github.com/linkwithjoydeep?tab=repositories" target="_blank" class="view-more-link">
          View More on GitHub →
        </a>
      </div>
    </section>

    <section id="education">
      <h2 class="section-title">Education</h2>

      {content.educations.map((education) => (
      <div class="education-item">
        <div class="education-header">
          <h3 class="degree-title">{education.degree}</h3>
          <div class="institution-info">
            <span class="institution">{education.institution}</span>
            {education.credentialUrl && (
            <a href={education.credentialUrl} target="_blank" class="credential-link">
              View Credential →
            </a>
            )}
          </div>
        </div>
      </div>
      ))}
    </section>

    <section id="recommendations">
      <div class="recommendations-content">
        <h2 class="section-title">Recommendations</h2>
        <a href={content.recommendations.url} target="_blank"
          class="recommendations-link">
          {content.recommendations.text}
        </a>
      </div>
    </section>

    <footer>
      <p>
        &copy; {content.footer.copyright}<br>
        {content.footer.madeBy} <a href={content.footer.websiteUrl} target="_blank">{content.name}</a>
      </p>
    </footer>
  </div>
</BaseLayout>

<script is:inline>

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".copy-btn");
    if (!btn) return;

    const email = btn.dataset.email;

    const tooltip = document.getElementById("copyTooltip");

    try {
      await navigator.clipboard.writeText(email);

      if (tooltip) {
        tooltip.classList.add("show");

        setTimeout(() => {
          tooltip.classList.remove("show");
        }, 2000);
      }
    } catch (err) {
      console.error("Failed to copy email:", err);

      if (tooltip) {
        tooltip.textContent = "Copy failed";
        tooltip.classList.add("show");

        setTimeout(() => {
          tooltip.classList.remove("show");
          tooltip.textContent = "Copied!";
        }, 2000);
      }
    }
  });
</script>
