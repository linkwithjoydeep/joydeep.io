---
interface Props {
  repos: Array<{
    owner: string;
    repo: string;
    tags?: string[];
    liveDemo?: string | null;
  }>;
}

const { repos } = Astro.props;
---

<div id="projects-container">
  {repos.map((repoConfig) => {
    const githubUrl = `https://github.com/${repoConfig.owner}/${repoConfig.repo}`;

    return (
      <div class="project-card" data-owner={repoConfig.owner} data-repo={repoConfig.repo}>
        <div class="project-card-header">
          <h3 class="project-title" data-field="name">{repoConfig.repo}</h3>
          <span class="github-stars" data-field="stars" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span data-stars-count>0</span>
          </span>
        </div>

        <p class="project-description" data-field="description">
          Loading...
        </p>

        <div class="tech-stack">
          <span class="tech-tag" data-field="language" style="display: none;"></span>
          {repoConfig.tags?.map(tag => (
            <span class="tech-tag">{tag}</span>
          ))}
        </div>

        <div class="project-actions">
          {repoConfig.liveDemo && (
            <a href={repoConfig.liveDemo} target="_blank" class="project-btn demo-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
                <path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm2-8h8v2H8v-2zm0 4h8v2H8v-2z"/>
              </svg>
              Live Demo
            </a>
          )}

          <a href={githubUrl} target="_blank" class="project-btn github-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
            </svg>
            View on GitHub
          </a>
        </div>
      </div>
    );
  })}
</div>

<script>
  // Fetch GitHub repo data on page load
  async function fetchGitHubRepoData(owner: string, repo: string) {
    try {
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status}`);
      }
      const data = await response.json();
      return {
        name: data.name,
        description: data.description,
        stars: data.stargazers_count,
        forks: data.forks_count,
        language: data.language,
        topics: data.topics || [],
        updatedAt: data.updated_at
      };
    } catch (error) {
      console.error(`Error fetching data for ${owner}/${repo}:`, error);
      return null;
    }
  }

  function updateProjectCard(card: HTMLElement, repoData: any) {
    if (!repoData) {
      const description = card.querySelector('[data-field="description"]');
      if (description) {
        description.textContent = "Failed to load repository data";
      }
      return;
    }

    // Update title
    const titleEl = card.querySelector('[data-field="name"]');
    if (titleEl) {
      titleEl.textContent = repoData.name;
    }

    // Update description
    const descriptionEl = card.querySelector('[data-field="description"]');
    if (descriptionEl) {
      descriptionEl.textContent = repoData.description || "No description available";
    }

    // Update stars
    const starsEl = card.querySelector('[data-field="stars"]') as HTMLElement;
    const starsCountEl = card.querySelector('[data-stars-count]');
    if (starsEl && starsCountEl) {
      starsCountEl.textContent = repoData.stars;
      starsEl.style.display = '';
    }

    // Update language
    const languageEl = card.querySelector('[data-field="language"]') as HTMLElement;
    if (languageEl && repoData.language) {
      languageEl.textContent = repoData.language;
      languageEl.style.display = '';
    }
  }

  // Load GitHub data when component mounts
  document.addEventListener("DOMContentLoaded", async () => {
    const projectCards = document.querySelectorAll('.project-card[data-owner][data-repo]');

    for (const card of projectCards) {
      const owner = (card as HTMLElement).dataset.owner;
      const repo = (card as HTMLElement).dataset.repo;

      if (owner && repo) {
        const repoData = await fetchGitHubRepoData(owner, repo);
        updateProjectCard(card as HTMLElement, repoData);
      }
    }
  });
</script>
